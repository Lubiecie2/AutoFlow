@{
    ViewData["Title"] = "ZarzƒÖdzanie Og≈Çoszeniami";
}

<link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />

<div class="admin-container">
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h2>AutoFlow</h2>
            <p>Panel Administratora</p>
        </div>

        <nav class="sidebar-menu">
            <a href="/Admin/Dashboard" class="menu-item">
                <i>üìä</i>
                <span>Dashboard</span>
            </a>
            <a href="/Admin/Users" class="menu-item">
                <i>üë•</i>
                <span>U≈ºytkownicy</span>
            </a>
            <a href="/Admin/Advertisements" class="menu-item active">
                <i>üìã</i>
                <span>Og≈Çoszenia</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                Wyloguj siƒô
            </button>
        </div>
    </aside>

    <main class="admin-content">
        <div class="content-header">
            <h1>ZarzƒÖdzanie Og≈Çoszeniami</h1>
            <p>Weryfikuj i zarzƒÖdzaj og≈Çoszeniami oczekujƒÖcymi na akceptacjƒô</p>
        </div>
        <div id="alertSuccess" class="alert alert-success" style="display: none;"></div>
        <div id="alertError" class="alert alert-error" style="display: none;"></div>

        <div class="card">
            <div class="card-header">
                <h2>Og≈Çoszenia oczekujƒÖce na weryfikacjƒô</h2>
                <span id="pendingCount" class="badge-count">0</span>
            </div>

            <div id="loadingSpinner" class="loading">
                <div class="spinner"></div>
                <p>≈Åadowanie og≈Çosze≈Ñ...</p>
            </div>

            <div id="advertisementsTable" style="display: none;">
                <table class="ads-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Marka</th>
                            <th>Model</th>
                            <th>Rok</th>
                            <th>Cena</th>
                            <th>U≈ºytkownik</th>
                            <th>Data dodania</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="advertisementsTableBody"></tbody>
                </table>
            </div>

            <div id="noAdvertisements" class="no-data" style="display: none;">
                <p>‚úÖ Brak og≈Çosze≈Ñ oczekujƒÖcych na weryfikacjƒô</p>
            </div>
        </div>
    </main>
</div>

@section Scripts {
    <script src="~/js/navigation.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', loadPendingAdvertisements);

        async function loadPendingAdvertisements() {
            try {
                const response = await fetch('/Admin/GetPendingAdvertisements');
                const data = await response.json();

                const loadingSpinner = document.getElementById('loadingSpinner');
                const advertisementsTable = document.getElementById('advertisementsTable');
                const noAdvertisements = document.getElementById('noAdvertisements');
                const pendingCount = document.getElementById('pendingCount');

                loadingSpinner.style.display = 'none';

                if (data.success && data.advertisements.length > 0) {
                    displayAdvertisements(data.advertisements);
                    advertisementsTable.style.display = 'block';
                    pendingCount.textContent = data.advertisements.length;
                } else {
                    noAdvertisements.style.display = 'block';
                    pendingCount.textContent = '0';
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas ≈Çadowania og≈Çosze≈Ñ');
                console.error(error);
            }
        }

        function displayAdvertisements(advertisements) {
    const tableBody = document.getElementById('advertisementsTableBody');
    tableBody.innerHTML = '';

    advertisements.forEach(ad => {
        const row = document.createElement('tr');
        
        const createdDate = new Date(ad.createdAt).toLocaleDateString('pl-PL', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });

        const price = ad.price.toLocaleString('pl-PL', {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        });

        row.innerHTML = `
            <td data-label="ID"><strong>#${ad.id}</strong></td>
            <td data-label="Marka">${ad.brand}</td>
            <td data-label="Model">${ad.model}</td>
            <td data-label="Rok">${ad.year}</td>
            <td data-label="Cena" class="price-cell">${price} PLN</td>
            <td data-label="U≈ºytkownik">${ad.username}</td>
            <td data-label="Data">${createdDate}</td>
            <td data-label="Akcje">
                <div class="action-buttons-inline">
                    <button class="btn-details" onclick="viewDetails(${ad.id})" title="Zobacz szczeg√≥≈Çy">
                        üëÅÔ∏è Szczeg√≥≈Çy
                    </button>
                    <button class="btn-approve" onclick="approveAdvertisement(${ad.id})" title="Zatwierd≈∫">
                        ‚úÖ
                    </button>
                    <button class="btn-reject" onclick="rejectAdvertisement(${ad.id})" title="Odrzuƒá">
                        ‚ùå
                    </button>
                </div>
            </td>
        `;

        tableBody.appendChild(row);
    });
}
 
        function viewDetails(id) {
    window.location.href = `/Advertisement/AdminPreview/${id}`;
}

        async function approveAdvertisement(id) {
            if (!confirm('Czy na pewno chcesz zatwierdziƒá to og≈Çoszenie?')) return;

            try {
                const response = await fetch(`/Admin/ApproveAdvertisement/${id}`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas zatwierdzania og≈Çoszenia');
                console.error(error);
            }
        }

        async function rejectAdvertisement(id) {
            if (!confirm('Czy na pewno chcesz odrzuciƒá to og≈Çoszenie?')) return;

            try {
                const response = await fetch(`/Admin/RejectAdvertisement/${id}`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas odrzucania og≈Çoszenia');
                console.error(error);
            }
        }

        function showSuccess(message) {
            const alert = document.getElementById('alertSuccess');
            alert.textContent = message;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const alert = document.getElementById('alertError');
            alert.textContent = message;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }
    </script>
}
