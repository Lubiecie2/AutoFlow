@{
    ViewData["Title"] = "ZarzƒÖdzanie Og≈Çoszeniami";
}

<link rel="stylesheet" href="~/css/admin.css" asp-append-version="true" />

<div class="admin-container">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <h2>AutoFlow</h2>
            <p>Panel Administratora</p>
        </div>

        <nav class="sidebar-menu">
            <a href="/Admin/Dashboard" class="menu-item">
                <i>üìä</i>
                <span>Dashboard</span>
            </a>
            <a href="/Admin/Users" class="menu-item">
                <i>üë•</i>
                <span>U≈ºytkownicy</span>
            </a>
            <a href="/Admin/Advertisements" class="menu-item active">
                <i>üìã</i>
                <span>Og≈Çoszenia</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <button class="logout-btn" onclick="logout()">
                Wyloguj siƒô
            </button>
        </div>
    </aside>

    <!-- G≈Ç√≥wna zawarto≈õƒá -->
    <main class="admin-content">
        <div class="content-header">
            <h1>ZarzƒÖdzanie Og≈Çoszeniami</h1>
            <p>Weryfikuj i zarzƒÖdzaj og≈Çoszeniami oczekujƒÖcymi na akceptacjƒô</p>
        </div>

        <!-- Komunikaty -->
        <div id="alertSuccess" class="alert alert-success" style="display: none;"></div>
        <div id="alertError" class="alert alert-error" style="display: none;"></div>

        <!-- Karta z og≈Çoszeniami oczekujƒÖcymi -->
        <div class="card">
            <div class="card-header">
                <h2>Og≈Çoszenia oczekujƒÖce na weryfikacjƒô</h2>
                <span id="pendingCount" class="badge-count">0</span>
            </div>

            <div id="loadingSpinner" class="loading">
                <div class="spinner"></div>
                <p>≈Åadowanie og≈Çosze≈Ñ...</p>
            </div>

            <div id="advertisementsContainer" style="display: none;">
                <div id="advertisementsList" class="advertisements-admin-grid"></div>
            </div>

            <div id="noAdvertisements" class="no-data" style="display: none;">
                <p>‚úÖ Brak og≈Çosze≈Ñ oczekujƒÖcych na weryfikacjƒô</p>
            </div>
        </div>
    </main>
</div>

<!-- Modal szczeg√≥≈Ç√≥w og≈Çoszenia -->
<div id="detailsModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Szczeg√≥≈Çy og≈Çoszenia</h3>
            <button class="close-modal" onclick="closeDetailsModal()">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- Dynamicznie wype≈Çniane -->
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeDetailsModal()">Zamknij</button>
            <button class="btn btn-delete" id="rejectBtn" onclick="rejectAdvertisement()">‚ùå Odrzuƒá</button>
            <button class="btn btn-save" id="approveBtn" onclick="approveAdvertisement()">‚úÖ Zatwierd≈∫</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/navigation.js"></script>
    <script>
        let currentAdvertisementId = null;

        document.addEventListener('DOMContentLoaded', loadPendingAdvertisements);

        async function loadPendingAdvertisements() {
            try {
                const response = await fetch('/Admin/GetPendingAdvertisements');
                const data = await response.json();

                const loadingSpinner = document.getElementById('loadingSpinner');
                const advertisementsContainer = document.getElementById('advertisementsContainer');
                const noAdvertisements = document.getElementById('noAdvertisements');
                const pendingCount = document.getElementById('pendingCount');

                loadingSpinner.style.display = 'none';

                if (data.success && data.advertisements.length > 0) {
                    displayAdvertisements(data.advertisements);
                    advertisementsContainer.style.display = 'block';
                    pendingCount.textContent = data.advertisements.length;
                } else {
                    noAdvertisements.style.display = 'block';
                    pendingCount.textContent = '0';
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas ≈Çadowania og≈Çosze≈Ñ');
                console.error(error);
            }
        }

        function displayAdvertisements(advertisements) {
            const container = document.getElementById('advertisementsList');
            container.innerHTML = '';

            advertisements.forEach(ad => {
                const card = document.createElement('div');
                card.className = 'ad-admin-card';

                const createdDate = new Date(ad.createdAt).toLocaleDateString('pl-PL', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const price = ad.price.toLocaleString('pl-PL', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                });

                card.innerHTML = `
                    <div class="ad-admin-header">
                        <h3>${ad.brand} ${ad.model}</h3>
                        <span class="ad-status status-pending">Oczekuje</span>
                    </div>
                    
                    <div class="ad-admin-info">
                        <div class="info-row">
                            <span class="info-label">üë§ U≈ºytkownik:</span>
                            <span class="info-value">${ad.username}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üìÖ Rocznik:</span>
                            <span class="info-value">${ad.year}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üé® Kolor:</span>
                            <span class="info-value">${ad.color}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üìè Przebieg:</span>
                            <span class="info-value">${ad.mileage.toLocaleString('pl-PL')} km</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">‚öôÔ∏è Silnik:</span>
                            <span class="info-value">${ad.engine}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üí∞ Cena:</span>
                            <span class="info-value price-highlight">${price} PLN</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üïê Dodano:</span>
                            <span class="info-value">${createdDate}</span>
                        </div>
                    </div>

                    ${ad.description ? `
                    <div class="ad-admin-description">
                        <strong>Opis:</strong>
                        <p>${ad.description}</p>
                    </div>
                    ` : ''}

                    <div class="ad-admin-actions">
                        <button class="btn-view" onclick="viewDetails(${ad.id}, '${ad.brand}', '${ad.model}', ${ad.year}, '${ad.color}', ${ad.mileage}, '${ad.engine}', ${ad.price}, '${ad.description || ''}', '${ad.username}', '${ad.createdAt}')">
                            üëÅÔ∏è Zobacz szczeg√≥≈Çy
                        </button>
                        <button class="btn-reject-quick" onclick="quickReject(${ad.id})">
                            ‚ùå Odrzuƒá
                        </button>
                        <button class="btn-approve-quick" onclick="quickApprove(${ad.id})">
                            ‚úÖ Zatwierd≈∫
                        </button>
                    </div>
                `;

                container.appendChild(card);
            });
        }

        function viewDetails(id, brand, model, year, color, mileage, engine, price, description, username, createdAt) {
            currentAdvertisementId = id;

            const createdDate = new Date(createdAt).toLocaleDateString('pl-PL', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });

            const priceFormatted = price.toLocaleString('pl-PL', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="details-grid">
                    <div class="detail-section">
                        <h4>Informacje o poje≈∫dzie</h4>
                        <div class="detail-item">
                            <span class="detail-label">Marka:</span>
                            <span class="detail-value">${brand}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Model:</span>
                            <span class="detail-value">${model}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Rocznik:</span>
                            <span class="detail-value">${year}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Kolor:</span>
                            <span class="detail-value">${color}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Przebieg:</span>
                            <span class="detail-value">${mileage.toLocaleString('pl-PL')} km</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Silnik:</span>
                            <span class="detail-value">${engine}</span>
                        </div>
                        <div class="detail-item highlight">
                            <span class="detail-label">Cena:</span>
                            <span class="detail-value">${priceFormatted} PLN</span>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4>Informacje o og≈Çoszeniu</h4>
                        <div class="detail-item">
                            <span class="detail-label">U≈ºytkownik:</span>
                            <span class="detail-value">${username}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Data dodania:</span>
                            <span class="detail-value">${createdDate}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value"><span class="status-badge status-pending">Oczekuje</span></span>
                        </div>
                    </div>

                    ${description ? `
                    <div class="detail-section full-width">
                        <h4>Opis</h4>
                        <div class="description-box">
                            ${description}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('detailsModal').style.display = 'flex';
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').style.display = 'none';
            currentAdvertisementId = null;
        }

        async function quickApprove(id) {
            if (!confirm('Czy na pewno chcesz zatwierdziƒá to og≈Çoszenie?')) return;

            try {
                const response = await fetch(`/Admin/ApproveAdvertisement/${id}`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    await loadPendingAdvertisements();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas zatwierdzania og≈Çoszenia');
                console.error(error);
            }
        }

        async function quickReject(id) {
            if (!confirm('Czy na pewno chcesz odrzuciƒá to og≈Çoszenie?')) return;

            try {
                const response = await fetch(`/Admin/RejectAdvertisement/${id}`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    await loadPendingAdvertisements();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas odrzucania og≈Çoszenia');
                console.error(error);
            }
        }

        async function approveAdvertisement() {
            if (!currentAdvertisementId) return;
            
            if (!confirm('Czy na pewno chcesz zatwierdziƒá to og≈Çoszenie?')) return;

            try {
                const response = await fetch(`/Admin/ApproveAdvertisement/${currentAdvertisementId}`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    closeDetailsModal();
                    await loadPendingAdvertisements();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas zatwierdzania og≈Çoszenia');
                console.error(error);
            }
        }

        async function rejectAdvertisement() {
            if (!currentAdvertisementId) return;
            
            if (!confirm('Czy na pewno chcesz odrzuciƒá to og≈Çoszenie?')) return;

            try {
                const response = await fetch(`/Admin/RejectAdvertisement/${currentAdvertisementId}`, {
                    method: 'PUT'
                });

                const data = await response.json();

                if (data.success) {
                    showSuccess(data.message);
                    closeDetailsModal();
                    await loadPendingAdvertisements();
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('B≈ÇƒÖd podczas odrzucania og≈Çoszenia');
                console.error(error);
            }
        }

        function showSuccess(message) {
            const alert = document.getElementById('alertSuccess');
            alert.textContent = message;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            const alert = document.getElementById('alertError');
            alert.textContent = message;
            alert.style.display = 'block';

            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Zamknij modal po klikniƒôciu poza nim
        window.onclick = function(event) {
            const modal = document.getElementById('detailsModal');
            if (event.target === modal) {
                closeDetailsModal();
            }
        }
    </script>
}
