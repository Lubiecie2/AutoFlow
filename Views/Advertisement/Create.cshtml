@{
    ViewData["Title"] = "Dodaj og≈Çoszenie";
}

<link rel="stylesheet" href="~/css/advertisement.css" asp-append-version="true" />

<div class="advertisement-container">
    <div class="container-wrapper">
        <div class="form-section">
            <div class="form-header">
                <h1>üìù Dodaj og≈Çoszenie</h1>
                <p>Wype≈Çnij formularz i dodaj zdjƒôcia</p>
            </div>

            <form id="advertisementForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="brand">Marka *</label>
                    <input type="text" id="brand" name="brand" required placeholder="np. BMW" />
                </div>

                <div class="form-group">
                    <label for="model">Model *</label>
                    <input type="text" id="model" name="model" required placeholder="np. 320i" />
                </div>

                <div class="form-group">
                    <label for="year">Rocznik *</label>
                    <input type="number" id="year" name="year" required min="1900" max="2100" placeholder="2020" />
                </div>

                <div class="form-group">
                    <label for="color">Kolor *</label>
                    <input type="text" id="color" name="color" required placeholder="Czarny" />
                </div>

                <div class="form-group">
                    <label for="mileage">Przebieg (km) *</label>
                    <input type="number" id="mileage" name="mileage" required min="0" placeholder="50000" />
                </div>

                <div class="form-group">
                    <label for="engine">Silnik *</label>
                    <input type="text" id="engine" name="engine" required placeholder="2.0 TDI" />
                </div>

                <div class="form-group">
                    <label for="price">Cena (PLN) *</label>
                    <input type="number" id="price" name="price" required min="0.01" step="0.01" placeholder="45000" />
                </div>

                <div class="form-group full-width">
                    <label for="description">Opis</label>
                    <textarea id="description" name="description" rows="4" placeholder="Dodatkowe informacje..."></textarea>
                </div>

                <!-- SEKCJA ZDJƒòƒÜ -->
                <div class="form-group full-width">
                    <label>Zdjƒôcia (min. 1, max. 10) *</label>
                    <div class="image-upload-area">
                        <input type="file" id="imageInput" accept="image/jpeg,image/jpg,image/png,image/webp" multiple style="display: none;" />
                        <button type="button" class="btn-upload" onclick="document.getElementById('imageInput').click()">
                            üì∑ Dodaj zdjƒôcia
                        </button>
                        <p class="upload-hint">Akceptowane formaty: JPG, PNG, WEBP (max 5MB ka≈ºde)</p>
                    </div>
                    <div id="imagePreviewContainer" class="image-preview-container"></div>
                </div>

                <div id="errorMessage" class="error-message" style="display: none;"></div>
                <div id="successMessage" class="success-message" style="display: none;"></div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="window.location.href='/'">Anuluj</button>
                    <button type="submit" class="btn-submit">üì§ Opublikuj og≈Çoszenie</button>
                </div>
            </form>
        </div>

        <div class="preview-section">
            <div class="preview-header">
                <h2>PodglƒÖd og≈Çoszenia</h2> 
            </div>

            <div class="preview-content">
                <div class="preview-images-card" id="previewImagesCard" style="display: none;">
                    <div class="preview-main-image" id="previewMainImage">
                        <img src="" alt="G≈Ç√≥wne zdjƒôcie" />
                    </div>
                    <div class="preview-thumbnails" id="previewThumbnails"></div>
                </div>
                <div class="preview-card">
                    <div class="preview-card-header">
                        <h2>Informacje o poje≈∫dzie</h2>
                    </div>

                    <div class="preview-info-grid">
                        <div class="preview-info-item">
                            <span class="preview-icon">üöó</span>
                            <div class="preview-text">
                                <span class="preview-label">Marka</span>
                                <span class="preview-value" id="previewBrand">-</span>
                            </div>
                        </div>

                        <div class="preview-info-item">
                            <span class="preview-icon">üè∑Ô∏è</span>
                            <div class="preview-text">
                                <span class="preview-label">Model</span>
                                <span class="preview-value" id="previewModel">-</span>
                            </div>
                        </div>

                        <div class="preview-info-item">
                            <span class="preview-icon">üìÖ</span>
                            <div class="preview-text">
                                <span class="preview-label">Rok produkcji</span>
                                <span class="preview-value" id="previewYear">-</span>
                            </div>
                        </div>

                        <div class="preview-info-item">
                            <span class="preview-icon">üé®</span>
                            <div class="preview-text">
                                <span class="preview-label">Kolor</span>
                                <span class="preview-value" id="previewColor">-</span>
                            </div>
                        </div>

                        <div class="preview-info-item">
                            <span class="preview-icon">üìè</span>
                            <div class="preview-text">
                                <span class="preview-label">Przebieg</span>
                                <span class="preview-value" id="previewMileage">-</span>
                            </div>
                        </div>

                        <div class="preview-info-item">
                            <span class="preview-icon">‚öôÔ∏è</span>
                            <div class="preview-text">
                                <span class="preview-label">Silnik</span>
                                <span class="preview-value" id="previewEngine">-</span>
                            </div>
                        </div>
                    </div>

                    <div class="preview-description-section" id="previewDescriptionSection" style="display: none;">
                        <h3>üìù Opis</h3>
                        <p id="previewDescription"></p>
                    </div>
                </div>

                <div class="preview-price-card">
                    <h3>Cena</h3>
                    <div class="preview-price-amount" id="previewPrice">0.00 PLN</div>
                </div>

                <div class="preview-seller-card">
                    <h3>SprzedajƒÖcy</h3>
                    <div class="preview-seller-info">
                        <div class="preview-seller-avatar">
                            <span>üë§</span>
                        </div>
                        <div class="preview-seller-details">
                            <p class="preview-seller-name" id="previewUsername">-</p>
                            <p class="preview-seller-date">Nowe og≈Çoszenie</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentUsername = 'U≈ºytkownik';
        let uploadedImages = [];
        let mainImageIndex = 0;

        document.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/Account/CurrentUser');
                const data = await response.json();
                
                if (data.success && data.isAuthenticated) {
                    currentUsername = data.username;
                    document.getElementById('previewUsername').textContent = currentUsername;
                }
            } catch (error) {
                console.error('B≈ÇƒÖd pobierania u≈ºytkownika:', error);
            }

            setupLivePreview();
            setupImageUpload();
        });

        function setupImageUpload() {
            const imageInput = document.getElementById('imageInput');
            
            imageInput.addEventListener('change', function(e) {
                const files = Array.from(e.target.files);
                
                if (uploadedImages.length + files.length > 10) {
                    showError('Maksymalnie mo≈ºna dodaƒá 10 zdjƒôƒá');
                    return;
                }

                files.forEach(file => {
                    if (file.size > 5242880) {
                        showError(`Plik ${file.name} jest za du≈ºy (max 5MB)`);
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(event) {
                        uploadedImages.push({
                            file: file,
                            dataUrl: event.target.result
                        });
                        displayImagePreviews();
                        updatePreviewImages();
                    };
                    reader.readAsDataURL(file);
                });

                imageInput.value = '';
            });
        }

        function displayImagePreviews() {
            const container = document.getElementById('imagePreviewContainer');
            container.innerHTML = '';

            uploadedImages.forEach((img, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'image-preview-item' + (index === mainImageIndex ? ' main-image' : '');
                
                wrapper.innerHTML = `
                    <img src="${img.dataUrl}" alt="PodglƒÖd ${index + 1}" />
                    <div class="image-preview-actions">
                        ${index === mainImageIndex 
                            ? '<span class="main-badge">‚≠ê G≈Ç√≥wne</span>' 
                            : `<button type="button" class="btn-set-main" onclick="setMainImage(${index})">Ustaw jako g≈Ç√≥wne</button>`
                        }
                        <button type="button" class="btn-remove-image" onclick="removeImage(${index})">üóëÔ∏è</button>
                    </div>
                    <span class="image-number">${index + 1}</span>
                `;
                
                container.appendChild(wrapper);
            });
        }

        function setMainImage(index) {
            mainImageIndex = index;
            displayImagePreviews();
            updatePreviewImages();
        }

        function removeImage(index) {
            uploadedImages.splice(index, 1);
            if (mainImageIndex >= uploadedImages.length) {
                mainImageIndex = Math.max(0, uploadedImages.length - 1);
            }
            displayImagePreviews();
            updatePreviewImages();
        }

        function updatePreviewImages() {
            const previewCard = document.getElementById('previewImagesCard');
            const mainImage = document.getElementById('previewMainImage');
            const thumbnails = document.getElementById('previewThumbnails');

            if (uploadedImages.length === 0) {
                previewCard.style.display = 'none';
                return;
            }

            previewCard.style.display = 'block';
            mainImage.querySelector('img').src = uploadedImages[mainImageIndex].dataUrl;

            thumbnails.innerHTML = '';
            uploadedImages.forEach((img, index) => {
                const thumb = document.createElement('div');
                thumb.className = 'preview-thumb' + (index === mainImageIndex ? ' active' : '');
                thumb.innerHTML = `<img src="${img.dataUrl}" alt="Miniatura ${index + 1}" />`;
                thumb.onclick = () => {
                    mainImageIndex = index;
                    updatePreviewImages();
                };
                thumbnails.appendChild(thumb);
            });
        }

        function setupLivePreview() {
            document.getElementById('brand').addEventListener('input', function(e) {
                document.getElementById('previewBrand').textContent = e.target.value || '-';
            });

            document.getElementById('model').addEventListener('input', function(e) {
                document.getElementById('previewModel').textContent = e.target.value || '-';
            });

            document.getElementById('year').addEventListener('input', function(e) {
                document.getElementById('previewYear').textContent = e.target.value || '-';
            });

            document.getElementById('color').addEventListener('input', function(e) {
                document.getElementById('previewColor').textContent = e.target.value || '-';
            });

            document.getElementById('mileage').addEventListener('input', function(e) {
                const value = e.target.value;
                if (value) {
                    const formatted = parseInt(value).toLocaleString('pl-PL');
                    document.getElementById('previewMileage').textContent = formatted + ' km';
                } else {
                    document.getElementById('previewMileage').textContent = '-';
                }
            });

            document.getElementById('engine').addEventListener('input', function(e) {
                document.getElementById('previewEngine').textContent = e.target.value || '-';
            });

            document.getElementById('price').addEventListener('input', function(e) {
                const value = e.target.value;
                if (value) {
                    const formatted = parseFloat(value).toLocaleString('pl-PL', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                    document.getElementById('previewPrice').textContent = formatted + ' PLN';
                } else {
                    document.getElementById('previewPrice').textContent = '0.00 PLN';
                }
            });

            document.getElementById('description').addEventListener('input', function(e) {
                const descSection = document.getElementById('previewDescriptionSection');
                const descText = document.getElementById('previewDescription');
                
                if (e.target.value.trim()) {
                    descText.textContent = e.target.value;
                    descSection.style.display = 'block';
                } else {
                    descSection.style.display = 'none';
                }
            });
        }

        document.getElementById('advertisementForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (uploadedImages.length === 0) {
                showError('Musisz dodaƒá co najmniej 1 zdjƒôcie');
                return;
            }
            
            const formData = new FormData();
            formData.append('Brand', document.getElementById('brand').value);
            formData.append('Model', document.getElementById('model').value);
            formData.append('Year', document.getElementById('year').value);
            formData.append('Color', document.getElementById('color').value);
            formData.append('Mileage', document.getElementById('mileage').value);
            formData.append('Engine', document.getElementById('engine').value);
            formData.append('Price', document.getElementById('price').value);
            formData.append('Description', document.getElementById('description').value || '');
            formData.append('MainImageIndex', mainImageIndex);

            uploadedImages.forEach((img, index) => {
                formData.append('Images', img.file);
            });
            
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
            
            try {
                const response = await fetch('/Advertisement/CreateWithImages', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess(data.message);
                    
                    setTimeout(() => {
                        window.location.href = '/Profile/Index';
                    }, 2000);
                } else {
                    showError(data.message);
                }
            } catch (error) {
                showError('WystƒÖpi≈Ç b≈ÇƒÖd podczas dodawania og≈Çoszenia');
                console.error(error);
            }
        });

        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function showSuccess(message) {
            const successMessage = document.getElementById('successMessage');
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
}
