@{
    ViewData["Title"] = "Strona główna";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />

<div class="home-container">
    <section class="hero-section">
        <h1>🚗 Witaj w AutoFlow</h1>
        <p>Twój rynek motoryzacyjny - kup lub sprzedaj pojazd w prosty sposób</p>
        
        <div id="userActions" class="action-buttons">
        </div>
    </section>

    <section class="advertisements-section">
        <div class="section-header">
            <h2>📋 Najnowsze ogłoszenia</h2>
            <p>Przeglądaj aktualne oferty samochodów</p>
        </div>

        <div id="loadingSpinner" class="loading">
            <div class="spinner"></div>
            <p>Ładowanie ogłoszeń...</p>
        </div>

        <div id="advertisementsList" class="advertisements-grid"></div>
        
        <div id="noAdvertisements" class="no-data" style="display: none;">
            <p>🔍 Brak ogłoszeń do wyświetlenia</p>
        </div>
    </section>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthAndUpdateActions();
            await loadAdvertisements();
        });

        async function checkAuthAndUpdateActions() {
            try {
                const response = await fetch('/Account/CurrentUser');
                const data = await response.json();
                
                const actionsDiv = document.getElementById('userActions');
                
                if (data.success && data.isAuthenticated) {
                    actionsDiv.innerHTML = `
                        <a href="/Advertisement/Create" class="btn-primary">➕ Dodaj ogłoszenie</a>
                        <a href="/Profile/Index" class="btn-secondary">👤 Mój profil</a>
                    `;
                } else {
                    actionsDiv.innerHTML = `
                        <a href="/Account/Login" class="btn-primary">Zaloguj się</a>
                        <a href="/Account/Register" class="btn-secondary">Zarejestruj się</a>
                    `;
                }
            } catch (error) {
                console.error('Błąd sprawdzania autoryzacji:', error);
            }
        }

        async function loadAdvertisements() {
            try {
                const response = await fetch('/Advertisement/GetAll');
                const data = await response.json();
                
                const loadingSpinner = document.getElementById('loadingSpinner');
                const advertisementsList = document.getElementById('advertisementsList');
                const noAdvertisements = document.getElementById('noAdvertisements');
                
                loadingSpinner.style.display = 'none';
                
                if (data.success && data.advertisements.length > 0) {
                    displayAdvertisements(data.advertisements);
                } else {
                    noAdvertisements.style.display = 'block';
                }
            } catch (error) {
                console.error('Błąd ładowania ogłoszeń:', error);
            }
        }

        function displayAdvertisements(advertisements) {
            const container = document.getElementById('advertisementsList');
            container.innerHTML = '';
            
            advertisements.forEach(ad => {
                const card = document.createElement('div');
                card.className = 'ad-card';
                
                const createdDate = new Date(ad.createdAt).toLocaleDateString('pl-PL');
                const price = ad.price.toLocaleString('pl-PL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                
                card.innerHTML = `
                    <div class="ad-header">
                        <h3>${ad.brand} ${ad.model}</h3>
                        <span class="ad-price">${price} PLN</span>
                    </div>
                    <div class="ad-details">
                        <div class="ad-detail-item">
                            <span class="detail-icon">📅</span>
                            <span>${ad.year}</span>
                        </div>
                        <div class="ad-detail-item">
                            <span class="detail-icon">🎨</span>
                            <span>${ad.color}</span>
                        </div>
                        <div class="ad-detail-item">
                            <span class="detail-icon">📏</span>
                            <span>${ad.mileage.toLocaleString('pl-PL')} km</span>
                        </div>
                        <div class="ad-detail-item">
                            <span class="detail-icon">⚙️</span>
                            <span>${ad.engine}</span>
                        </div>
                    </div>
                    ${ad.description ? `<p class="ad-description">${ad.description}</p>` : ''}
                    <div class="ad-footer">
                        <span class="ad-author">👤 ${ad.username}</span>
                        <span class="ad-date">${createdDate}</span>
                    </div>
                `;
                
                container.appendChild(card);
            });
        }
    </script>
}
