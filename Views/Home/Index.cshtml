@{
    ViewData["Title"] = "Strona główna";
    Layout = "_Layout";
}

<link rel="stylesheet" href="~/css/home.css" asp-append-version="true" />

<div class="home-container">
    <section class="top-section">
        <div class="top-section-wrapper">

            <aside class="filters-box">
                <h2 class="filters-title">🔍 Wyszukaj swój samochód</h2>
                
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="filterBrand">Marka</label>
                        <select id="filterBrand" class="filter-input">
                            <option value="">Wszystkie marki</option>
                            <option value="BMW">BMW</option>
                            <option value="Audi">Audi</option>
                            <option value="Mercedes">Mercedes-Benz</option>
                            <option value="Volkswagen">Volkswagen</option>
                            <option value="Toyota">Toyota</option>
                            <option value="Ford">Ford</option>
                            <option value="Opel">Opel</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label for="filterModel">Model</label>
                        <input type="text" id="filterModel" class="filter-input" placeholder="np. 320i">
                    </div>

                    <div class="filter-group">
                        <label for="filterYearFrom">Rok od</label>
                        <input type="number" id="filterYearFrom" class="filter-input" placeholder="2015" min="1900" max="2100">
                    </div>

                    <div class="filter-group">
                        <label for="filterYearTo">Rok do</label>
                        <input type="number" id="filterYearTo" class="filter-input" placeholder="2023" min="1900" max="2100">
                    </div>

                    <div class="filter-group">
                        <label for="filterPriceFrom">Cena od (PLN)</label>
                        <input type="number" id="filterPriceFrom" class="filter-input" placeholder="10 000" min="0">
                    </div>

                    <div class="filter-group">
                        <label for="filterPriceTo">Cena do (PLN)</label>
                        <input type="number" id="filterPriceTo" class="filter-input" placeholder="50 000" min="0">
                    </div>
                </div>

                <div class="filter-buttons">
                    <button class="btn-search" onclick="searchAdvertisements()">Szukaj</button>
                    <button class="btn-reset" onclick="resetFilters()">Wyczyść filtry</button>
                </div>
            </aside>

            <div class="hero-text">
                <h1>Znajdź wymarzony<br>samochód</h1>
                <p>Tysiące ofert w jednym miejscu.<br>Bezpieczne i szybkie transakcje.</p>
                
                <div class="hero-features">
                    <div class="feature-item">
                        <span class="icon">✅</span>
                        <span>Zweryfikowane ogłoszenia</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">🚗</span>
                        <span>Szeroki wybór aut</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">💰</span>
                        <span>Najlepsze ceny</span>
                    </div>
                    <div class="feature-item">
                        <span class="icon">⚡</span>
                        <span>Szybki kontakt</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="featured-section">
        <div class="section-header">
            <h2>⭐ Polecane ogłoszenia</h2>
            <p id="resultsCount">Sprawdź najlepsze oferty</p>
        </div>

        <div id="loadingSpinner" class="loading">
            <div class="spinner"></div>
            <p>Ładowanie ogłoszeń...</p>
        </div>

        <div id="featuredGrid" class="featured-grid"></div>

        <div id="noAdvertisements" class="no-data" style="display: none;">
            <p>🔍 Brak ogłoszeń spełniających kryteria</p>
        </div>
    </section>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Potwierdź usunięcie</h3>
            <button class="close-modal" onclick="closeDeleteModalHome()">&times;</button>
        </div>
        <div class="modal-body">
            <p>Czy na pewno chcesz usunąć ogłoszenie <strong id="deleteAdTitleHome"></strong>?</p>
            <p style="color: #e74c3c; margin-top: 10px;">Ta operacja jest nieodwracalna!</p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-cancel" onclick="closeDeleteModalHome()">Anuluj</button>
            <button class="btn btn-delete" onclick="confirmDeleteHome()">Usuń</button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let allAdvertisements = [];
        let currentUserRole = null;
        let currentDeleteAdIdHome = null;

        document.addEventListener('DOMContentLoaded', async function() {
            await checkUserRole();
            await loadAdvertisements();
        });

        async function checkUserRole() {
            try {
                const response = await fetch('/Account/CurrentUser');
                const data = await response.json();
                
                if (data.success && data.isAuthenticated) {
                    currentUserRole = data.role;
                }
            } catch (error) {
                console.error('Błąd pobierania roli użytkownika:', error);
            }
        }

        async function loadAdvertisements() {
            try {
                const response = await fetch('/Advertisement/GetAll');
                const data = await response.json();
                
                const loadingSpinner = document.getElementById('loadingSpinner');
                
                loadingSpinner.style.display = 'none';
                
                if (data.success && data.advertisements.length > 0) {
                    allAdvertisements = data.advertisements;
                    displayAdvertisements(allAdvertisements);
                    updateResultsCount(allAdvertisements.length);
                } else {
                    document.getElementById('noAdvertisements').style.display = 'block';
                }
            } catch (error) {
                console.error('Błąd ładowania ogłoszeń:', error);
            }
        }

        function displayAdvertisements(advertisements) {
            const container = document.getElementById('featuredGrid');
            const noAdvertisements = document.getElementById('noAdvertisements');
            
            container.innerHTML = '';
            
            if (advertisements.length === 0) {
                container.style.display = 'none';
                noAdvertisements.style.display = 'block';
                return;
            }

            container.style.display = 'grid';
            noAdvertisements.style.display = 'none';

        
            const toDisplay = advertisements.slice(0, 6);

            toDisplay.forEach(ad => {
                const card = createCard(ad);
                container.appendChild(card);
            });
        }

        function createCard(ad) {
            const card = document.createElement('div');
            card.className = 'featured-card';

            const price = ad.price.toLocaleString('pl-PL', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            const imageUrl = ad.mainImage || '/images/no-image.jpg';

            card.innerHTML = `
                <div class="card-image" style="background-image: url('${imageUrl}')">
                    ${ad.imageCount > 1 ? `<div class="photo-badge">📷 ${ad.imageCount}</div>` : ''}
                    ${currentUserRole === 'Admin' ? `<button class="btn-delete-card" onclick="event.stopPropagation(); openDeleteModalHome(${ad.id}, '${ad.brand} ${ad.model}')" title="Usuń ogłoszenie">🗑️</button>` : ''}
                </div>
                <div class="card-content">
                    <h3 class="card-title">${ad.brand} ${ad.model}</h3>
                    <div class="card-specs">
                        <span>📅 ${ad.year}</span>
                        <span>📏 ${ad.mileage.toLocaleString('pl-PL')} km</span>
                        <span>⚙️ ${ad.engine}</span>
                    </div>
                    <div class="card-footer">
                        <span class="card-price">${price} PLN</span>
                        <span class="card-author">👤 ${ad.username}</span>
                    </div>
                </div>
            `;

            card.onclick = () => window.location.href = `/Advertisement/Details/${ad.id}`;

            return card;
        }

        function openDeleteModalHome(adId, adTitle) {
            currentDeleteAdIdHome = adId;
            document.getElementById('deleteAdTitleHome').textContent = adTitle;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDeleteModalHome() {
            document.getElementById('deleteModal').classList.remove('show');
            currentDeleteAdIdHome = null;
        }

        async function confirmDeleteHome() {
            try {
                const response = await fetch(`/Admin/DeleteAdvertisement/${currentDeleteAdIdHome}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                closeDeleteModalHome();
        
                if (data.success) {
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                } else {
                    alert(data.message);
                }
            } catch (error) {
                alert('Błąd podczas usuwania ogłoszenia');
                console.error(error);
            }
        }

        function searchAdvertisements() {
            const brand = document.getElementById('filterBrand').value.toLowerCase();
            const model = document.getElementById('filterModel').value.toLowerCase();
            const yearFrom = parseInt(document.getElementById('filterYearFrom').value) || 0;
            const yearTo = parseInt(document.getElementById('filterYearTo').value) || 9999;
            const priceFrom = parseFloat(document.getElementById('filterPriceFrom').value) || 0;
            const priceTo = parseFloat(document.getElementById('filterPriceTo').value) || Infinity;

            const filtered = allAdvertisements.filter(ad => {
                const matchBrand = !brand || ad.brand.toLowerCase().includes(brand);
                const matchModel = !model || ad.model.toLowerCase().includes(model);
                const matchYear = ad.year >= yearFrom && ad.year <= yearTo;
                const matchPrice = ad.price >= priceFrom && ad.price <= priceTo;

                return matchBrand && matchModel && matchYear && matchPrice;
            });

            displayAdvertisements(filtered);
            updateResultsCount(filtered.length);
        }

        function resetFilters() {
            document.getElementById('filterBrand').value = '';
            document.getElementById('filterModel').value = '';
            document.getElementById('filterYearFrom').value = '';
            document.getElementById('filterYearTo').value = '';
            document.getElementById('filterPriceFrom').value = '';
            document.getElementById('filterPriceTo').value = '';

            displayAdvertisements(allAdvertisements);
            updateResultsCount(allAdvertisements.length);
        }

        function updateResultsCount(count) {
            const resultsCount = document.getElementById('resultsCount');
            resultsCount.textContent = `Znaleziono ${count} ${count === 1 ? 'ogłoszenie' : count < 5 && count > 1 ? 'ogłoszenia' : 'ogłoszeń'}`;
        }
    </script>
}